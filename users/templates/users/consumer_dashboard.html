{% extends "base.html" %}
{% load static %}

{% block title %}Consumer Dashboard - Business Directory 2.0{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/consumer_dashboard.css' %}">
<!-- Include Toastify CSS if not already in base -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
{% endblock %}

{% block content %}
<main class="consumer-dashboard">
  <!-- Header Section -->
  <header class="dashboard-header">
    <h1>Welcome, <span id="user-first-name">{{ user.first_name|default:"there" }}</span>!</h1>
    <div class="logout-container">
      <a href="{% url 'logout' %}" class="logout-button">
        <i class="fas fa-sign-out-alt"></i> 
        <span class="logout-text">Logout</span>
      </a>
      <button class="dashboard-hamburger" aria-label="Toggle dashboard menu">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Desktop Dashboard Tabs -->
  <nav class="dashboard-tabs" role="tablist">
    <button class="tab-button active" data-tab="profile" role="tab" aria-selected="true" aria-controls="profile-section">
      <i class="fas fa-user"></i> 
      <span>My Profile</span>
    </button>
    <button class="tab-button" data-tab="preferences" role="tab" aria-selected="false" aria-controls="preferences-section">
      <i class="fas fa-sliders-h"></i> 
      <span>Service Preferences</span>
    </button>
    <button class="tab-button" data-tab="offers" role="tab" aria-selected="false" aria-controls="offers-section">
      <i class="fas fa-tags"></i> 
      <span>Promotional Offers</span>
    </button>
    <button class="tab-button" data-tab="inbox" role="tab" aria-selected="false" aria-controls="inbox-section">
      <i class="fas fa-envelope"></i> 
      <span>Notifications</span>
      <span class="inbox-badge" id="unread-count">3</span>
    </button>
    <button class="tab-button" data-tab="notifications" role="tab" aria-selected="false" aria-controls="notifications-section">
      <i class="fas fa-bell"></i> 
      <span>Notification Settings</span>
    </button>
  </nav>

  <!-- Mobile Dashboard Sidebar -->
  <aside class="dashboard-sidebar" role="navigation" aria-label="Mobile dashboard menu">
    <div class="sidebar-header">
      <h3>Dashboard Menu</h3>
      <button class="close-sidebar" aria-label="Close menu">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button class="sidebar-tab-button active" data-tab="profile">
          <i class="fas fa-user"></i> My Profile
        </button>
      </li>
      <li>
        <button class="sidebar-tab-button" data-tab="preferences">
          <i class="fas fa-sliders-h"></i> Service Preferences
        </button>
      </li>
      <li>
        <button class="sidebar-tab-button" data-tab="offers">
          <i class="fas fa-tags"></i> Promotional Offers
        </button>
      </li>
      <li>
        <button class="sidebar-tab-button" data-tab="inbox">
          <i class="fas fa-envelope"></i> Email Inbox
          <span class="inbox-badge">3</span>
        </button>
      </li>
      <li>
        <button class="sidebar-tab-button" data-tab="notifications">
          <i class="fas fa-bell"></i> Notification Settings
        </button>
      </li>
    </ul>
  </aside>

  <!-- Dashboard Sidebar Overlay -->
  <div class="dashboard-overlay" aria-hidden="true"></div>

  <!-- Dashboard Stats -->
  <section class="dashboard-stats" aria-label="Dashboard statistics">
    <div class="stat-card">
      <div class="stat-number" id="total-offers">{{ total_offers|default:"0" }}</div>
      <div class="stat-label">Total Offers</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="active-offers">{{ active_offers|default:"0" }}</div>
      <div class="stat-label">Active Offers</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="expiring-soon">{{ expiring_soon|default:"0" }}</div>
      <div class="stat-label">Expiring Soon</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="unread-emails">3</div>
      <div class="stat-label">Unread Emails</div>
    </div>
  </section>

  <!-- Tab Content -->
  <section class="dashboard-content active" id="profile-section" role="tabpanel" aria-labelledby="profile-tab">
    {% include "users/consumer_dashboard_profile.html" %}
  </section>
  
  <section class="dashboard-content" id="preferences-section" role="tabpanel" aria-labelledby="preferences-tab">
    {% include "users/consumer_dashboard_preferences.html" %}
  </section>
  
  <section class="dashboard-content" id="offers-section" role="tabpanel" aria-labelledby="offers-tab">
    {% include "users/consumer_dashboard_offers.html" %}
  </section>
  
  <section class="dashboard-content" id="inbox-section" role="tabpanel" aria-labelledby="inbox-tab">
    {% include "users/consumer_dashboard_inbox.html" %}
  </section>
  
  <section class="dashboard-content" id="notifications-section" role="tabpanel" aria-labelledby="notifications-tab">
    {% include "users/consumer_dashboard_notifications.html" %}
  </section>
</main>

<style>
/* Inbox Badge Styles */
.inbox-badge {
  background: linear-gradient(135deg, var(--danger-color) 0%, #e83e8c 100%);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 0.5rem;
  animation: pulse 2s infinite;
}

.sidebar-tab-button .inbox-badge {
  margin-left: auto;
  margin-right: 0;
}

/* Additional stat card */
.dashboard-stats {
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.stat-card:nth-child(4)::before {
  background: linear-gradient(90deg, var(--info-color), #20c997);
}

@media (max-width: 768px) {
  .dashboard-stats {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>

{% endblock %}

{% block extra_js %}
<!-- Include Toastify JS -->
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
// Dashboard Manager Class
class DashboardManager {
  constructor() {
    this.currentTab = 'profile';
    this.initializeElements();
    this.bindEvents();
    this.initialize();
  }

  initializeElements() {
    // Tab elements
    this.tabButtons = document.querySelectorAll('.tab-button, .sidebar-tab-button');
    this.tabSections = document.querySelectorAll('.dashboard-content');
    
    // Mobile menu elements
    this.hamburger = document.querySelector('.dashboard-hamburger');
    this.sidebar = document.querySelector('.dashboard-sidebar');
    this.overlay = document.querySelector('.dashboard-overlay');
    this.closeSidebar = document.querySelector('.close-sidebar');
    
    // Form elements
    this.profileForm = document.querySelector('.profile-form');
    this.preferencesForm = document.querySelector('.preferences-form');
    this.notificationForm = document.querySelector('.notification-form');
    
    // State/County/City selects
    this.stateSelect = document.getElementById('state');
    this.countySelect = document.getElementById('county');
    this.citySelect = document.getElementById('city');
  }

  bindEvents() {
    // Tab switching
    this.tabButtons.forEach(button => {
      button.addEventListener('click', (e) => this.switchTab(e.currentTarget.dataset.tab));
    });

    // Mobile menu
    if (this.hamburger) {
      this.hamburger.addEventListener('click', () => this.openSidebar());
    }
    if (this.closeSidebar) {
      this.closeSidebar.addEventListener('click', () => this.closeSidebar());
    }
    if (this.overlay) {
      this.overlay.addEventListener('click', () => this.closeSidebar());
    }

    // Form submissions
    if (this.profileForm) {
      this.profileForm.addEventListener('submit', (e) => this.handleProfileSubmit(e));
    }
    if (this.preferencesForm) {
      this.preferencesForm.addEventListener('submit', (e) => this.handlePreferencesSubmit(e));
    }
    if (this.notificationForm) {
      this.notificationForm.addEventListener('submit', (e) => this.handleNotificationSubmit(e));
    }

    // Location selects
    if (this.stateSelect) {
      this.stateSelect.addEventListener('change', (e) => this.handleStateChange(e));
    }
    if (this.countySelect) {
      this.countySelect.addEventListener('change', (e) => this.handleCountyChange(e));
    }

    // Profile completion tracking
    const profileInputs = document.querySelectorAll('.profile-form input, .profile-form select');
    profileInputs.forEach(input => {
      input.addEventListener('input', () => this.calculateProfileCompletion());
    });
  }

  initialize() {
    // Initialize profile if on profile tab
    if (this.currentTab === 'profile') {
      this.initializeProfile();
    }

    // Check URL hash for initial tab
    const hash = window.location.hash.replace('#', '');
    if (hash && ['profile', 'preferences', 'offers', 'inbox', 'notifications'].includes(hash)) {
      this.switchTab(hash);
    }

    // Initialize offer filters
    this.initializeOfferFilters();

    // Initialize notification settings
    this.initializeNotificationSettings();

    // Initialize inbox
    this.initializeInbox();

    // Initialize project timeline
    this.initializeProjectTimeline();
  }

  // Tab Management
  switchTab(tabName) {
    // Update active states
    this.tabButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tabName);
      btn.setAttribute('aria-selected', btn.dataset.tab === tabName);
    });

    this.tabSections.forEach(section => {
      section.classList.toggle('active', section.id === `${tabName}-section`);
    });

    this.currentTab = tabName;
    window.location.hash = tabName;

    // Close mobile sidebar
    this.closeSidebar();

    // Load tab-specific data
    switch(tabName) {
      case 'offers':
        this.loadOffers();
        break;
      case 'inbox':
        this.loadInboxEmails();
        break;
      case 'notifications':
        this.loadNotificationSettings();
        break;
    }
  }

  // Mobile Menu
  openSidebar() {
    this.sidebar.classList.add('active');
    this.overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  closeSidebar() {
    this.sidebar.classList.remove('active');
    this.overlay.classList.remove('active');
    document.body.style.overflow = '';
  }

  // Profile Management
  initializeProfile() {
    this.populateStates();
    this.calculateProfileCompletion();
  }

  populateStates() {
    if (!this.stateSelect || this.stateSelect.options.length > 1) return;

    const states = {
      'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
      'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
      'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii', 'ID': 'Idaho',
      'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas',
      'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
      'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
      'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada',
      'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico', 'NY': 'New York',
      'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio', 'OK': 'Oklahoma',
      'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
      'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
      'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia',
      'WI': 'Wisconsin', 'WY': 'Wyoming'
    };

    Object.entries(states).forEach(([code, name]) => {
      const option = new Option(name, code);
      this.stateSelect.add(option);
    });

    // Set current state if any
    const currentState = this.stateSelect.dataset.current;
    if (currentState) {
      this.stateSelect.value = currentState;
      this.countySelect.disabled = false;
    }
  }

  calculateProfileCompletion() {
    const requiredFields = [
      'first-name', 'last-name', 'email', 'phone',
      'address-number', 'address-street', 'state', 'city', 'zip'
    ];

    const filledFields = requiredFields.filter(id => {
      const field = document.getElementById(id);
      return field && field.value.trim() !== '';
    });

    const percentage = Math.round((filledFields.length / requiredFields.length) * 100);
    
    const progressBar = document.getElementById('profile-progress');
    const percentageText = document.querySelector('.completion-percentage');
    
    if (progressBar) {
      progressBar.style.width = `${percentage}%`;
    }
    if (percentageText) {
      percentageText.textContent = `${percentage}%`;
    }
  }

  handleStateChange(e) {
    const state = e.target.value;
    this.countySelect.disabled = !state;
    this.countySelect.innerHTML = '<option value="">Select a County</option>';
    this.citySelect.disabled = true;
    this.citySelect.innerHTML = '<option value="">Select a City</option>';

    if (state) {
      // In production, make AJAX call to get counties
      this.loadCounties(state);
    }
  }

  handleCountyChange(e) {
    const county = e.target.value;
    this.citySelect.disabled = !county;
    this.citySelect.innerHTML = '<option value="">Select a City</option>';

    if (county) {
      // In production, make AJAX call to get cities
      this.loadCities(this.stateSelect.value, county);
    }
  }

  loadCounties(state) {
    // Simulated for demo - replace with actual AJAX call
    const dummyCounties = ['County 1', 'County 2', 'County 3'];
    dummyCounties.forEach(county => {
      const option = new Option(county, county);
      this.countySelect.add(option);
    });
  }

  loadCities(state, county) {
    // Simulated for demo - replace with actual AJAX call
    const dummyCities = ['City 1', 'City 2', 'City 3'];
    dummyCities.forEach(city => {
      const option = new Option(city, city);
      this.citySelect.add(city);
    });
  }

  async handleProfileSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(this.profileForm);
    const submitBtn = this.profileForm.querySelector('[type="submit"]');
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    try {
      const response = await fetch(this.profileForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
      });

      const data = await response.json();
      
      if (data.status === 'success') {
        this.showToast(data.message, 'success');
        this.updateLastUpdated();
        this.updateWelcomeName(formData.get('first_name'));
        this.calculateProfileCompletion();
      } else {
        this.showToast(data.message || 'An error occurred', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      this.showToast('An error occurred while updating profile', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
    }
  }

  async handlePreferencesSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(this.preferencesForm);
    const submitBtn = this.preferencesForm.querySelector('[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

    try {
      const response = await fetch(this.preferencesForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
      });

      const data = await response.json();
      
      if (data.status === 'success') {
        this.showToast(data.message, 'success');
        // Generate timeline-based notification schedule
        this.generateTimelineSchedule(formData);
      } else {
        this.showToast(data.message || 'An error occurred', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      this.showToast('An error occurred while updating preferences', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-check"></i> Update Preferences';
    }
  }

  async handleNotificationSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(this.notificationForm);
    const submitBtn = this.notificationForm.querySelector('[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    try {
      const response = await fetch('{% url "user_notifications" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
      });

      const data = await response.json();
      
      if (data.status === 'success') {
        this.showToast(data.message, 'success');
      } else {
        this.showToast('An error occurred while updating notification settings', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      this.showToast('An error occurred while updating notification settings', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Settings';
    }
  }

  // Project Timeline Management
  initializeProjectTimeline() {
    const timelineRadios = document.querySelectorAll('input[name="project_timeline"]');
    const timelineInputs = document.querySelectorAll('input[name="specific_timeline"]');
    
    timelineRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        this.updateTimelineNotificationPreview();
      });
    });

    timelineInputs.forEach(input => {
      input.addEventListener('input', () => {
        this.updateTimelineNotificationPreview();
      });
    });

    // Initialize preview
    this.updateTimelineNotificationPreview();
  }

  updateTimelineNotificationPreview() {
    const selectedTimeline = document.querySelector('input[name="project_timeline"]:checked');
    const preview = document.getElementById('timeline-notification-preview');
    
    if (!selectedTimeline || !preview) return;

    const timelineValue = selectedTimeline.value;
    const timelineText = selectedTimeline.nextElementSibling.textContent;
    
    let scheduleText = '';
    switch(timelineValue) {
      case '1':
        scheduleText = 'You will receive weekly notifications with relevant offers starting immediately.';
        break;
      case '2':
        scheduleText = 'You will receive bi-weekly notifications with offers for the next 2 months.';
        break;
      case '3':
        scheduleText = 'You will receive monthly notifications with offers for the next 3 months.';
        break;
      case 'specific':
        const specificDate = document.querySelector('input[name="specific_timeline"]').value;
        if (specificDate) {
          scheduleText = `You will receive targeted notifications leading up to your planned start date: ${new Date(specificDate).toLocaleDateString()}.`;
        } else {
          scheduleText = 'Please select a specific date to see notification schedule.';
        }
        break;
      default:
        scheduleText = 'No timeline selected.';
    }

    preview.innerHTML = `
      <div class="timeline-preview-content">
        <h4><i class="fas fa-calendar-check"></i> Notification Schedule Preview</h4>
        <p><strong>Selected Timeline:</strong> ${timelineText}</p>
        <p><strong>Schedule:</strong> ${scheduleText}</p>
      </div>
    `;
  }

  generateTimelineSchedule(formData) {
    const timeline = formData.get('project_timeline');
    if (!timeline) return;

    // Simulate generating notification schedule
    this.showToast(`Timeline-based notifications scheduled for ${timeline} month(s)`, 'success');
    
    // You could also trigger automatic email generation here
    setTimeout(() => {
      this.generateTimelineEmails(timeline);
    }, 2000);
  }

  generateTimelineEmails(timeline) {
    // Simulate generating timeline-based emails
    const timelineEmails = {
      '1': 'Welcome! Your 1-month project timeline notifications are now active.',
      '2': 'Great choice! We\'ll send you offers over the next 2 months.',
      '3': 'Perfect planning! You\'ll receive quarterly updates for your 3-month timeline.'
    };

    const message = timelineEmails[timeline] || 'Timeline notifications configured.';
    
    // Add to mock inbox
    this.addMockEmail({
      subject: 'Project Timeline Notifications Activated',
      sender: 'system@businessdirectory.com',
      preview: message,
      type: 'timeline',
      timestamp: new Date()
    });

    this.showToast('Timeline notification email generated!', 'info');
  }

  // Inbox Management
  initializeInbox() {
    // Load initial mock emails
    this.loadInboxEmails();
    
    // Setup inbox filters
    const filterButtons = document.querySelectorAll('.inbox-filter-btn');
    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        this.filterInboxEmails(btn.dataset.filter);
      });
    });

    // Setup email actions
    document.addEventListener('click', (e) => {
      if (e.target.closest('.email-item')) {
        this.handleEmailClick(e);
      }
    });
  }

  loadInboxEmails() {
    const emailContainer = document.querySelector('.email-list');
    if (!emailContainer) return;

    // Mock email data
    const mockEmails = [
      {
        id: 1,
        subject: '🔥 25% OFF Plumbing Services - Limited Time!',
        sender: 'QuickFix Plumbing',
        senderEmail: 'offers@quickfixplumbing.com',
        preview: 'Special discount on all residential plumbing services. Use code SAVE25. Valid until month end.',
        content: this.generateEmailContent('plumbing', '25% OFF', 'SAVE25'),
        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
        type: 'promotional',
        isRead: false,
        category: 'plumbing'
      },
      {
        id: 2,
        subject: '⚡ Electrical Services - 30% Discount This Week',
        sender: 'PowerPro Electric',
        senderEmail: 'deals@powerproelectric.com',
        preview: 'Professional electrical work with 30% off. Licensed electricians, free estimates.',
        content: this.generateEmailContent('electrical', '30% OFF', 'ELECTRIC30'),
        timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
        type: 'promotional',
        isRead: false,
        category: 'electrical'
      },
      {
        id: 3,
        subject: 'Your Project Timeline Notifications Are Active',
        sender: 'Business Directory System',
        senderEmail: 'system@businessdirectory.com',
        preview: 'Timeline-based notifications have been set up for your 2-month project planning.',
        content: this.generateSystemEmailContent(),
        timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000), // 1 day ago
        type: 'system',
        isRead: true,
        category: 'system'
      }
    ];

    this.renderEmails(mockEmails);
    this.updateInboxStats(mockEmails);
  }

  renderEmails(emails) {
    const emailContainer = document.querySelector('.email-list');
    if (!emailContainer) return;

    emailContainer.innerHTML = emails.map(email => this.createEmailItem(email)).join('');
  }

  createEmailItem(email) {
    const timeAgo = this.getTimeAgo(email.timestamp);
    const isUnread = !email.isRead;
    
    return `
      <div class="email-item ${isUnread ? 'unread' : ''}" data-email-id="${email.id}">
        <div class="email-avatar">
          <i class="fas ${this.getEmailIcon(email.type)}"></i>
        </div>
        <div class="email-content">
          <div class="email-header">
            <div class="email-sender">${email.sender}</div>
            <div class="email-timestamp">${timeAgo}</div>
          </div>
          <div class="email-subject">${email.subject}</div>
          <div class="email-preview">${email.preview}</div>
          <div class="email-actions">
            <button class="email-action-btn read-btn" data-action="read">
              <i class="fas fa-envelope-open"></i> Mark Read
            </button>
            <button class="email-action-btn delete-btn" data-action="delete">
              <i class="fas fa-trash"></i> Delete
            </button>
            <button class="email-action-btn view-btn" data-action="view">
              <i class="fas fa-eye"></i> View Full Email
            </button>
          </div>
        </div>
      </div>
    `;
  }

  generateEmailContent(category, discount, code) {
    return `
      <div class="email-full-content">
        <h2>Special ${discount} ${category.charAt(0).toUpperCase() + category.slice(1)} Offer!</h2>
        <p>Dear Valued Customer,</p>
        <p>We're excited to offer you an exclusive <strong>${discount}</strong> discount on all ${category} services!</p>
        
        <div class="offer-highlight">
          <h3>🎯 What's Included:</h3>
          <ul>
            <li>Professional ${category} services</li>
            <li>Licensed and insured technicians</li>
            <li>Free estimates and consultations</li>
            <li>Satisfaction guarantee</li>
          </ul>
        </div>

        <div class="promo-code-section">
          <h3>💰 Your Promo Code:</h3>
          <div class="promo-code-display">${code}</div>
          <p>Use this code when booking to receive your discount!</p>
        </div>

        <div class="contact-info">
          <h3>📞 Contact Us:</h3>
          <p>Phone: (555) 123-4567</p>
          <p>Email: contact@${category}services.com</p>
          <p>Address: 123 Service St, Your City, ST 12345</p>
        </div>

        <p>This offer is valid until the end of this month. Don't miss out!</p>
        
        <div class="email-footer">
          <p>Best regards,<br>The ${category.charAt(0).toUpperCase() + category.slice(1)} Services Team</p>
        </div>
      </div>
    `;
  }

  generateSystemEmailContent() {
    return `
      <div class="email-full-content system-email">
        <h2>🎯 Project Timeline Notifications Activated</h2>
        <p>Hello,</p>
        <p>Your project timeline notifications have been successfully configured!</p>
        
        <div class="timeline-summary">
          <h3>📅 Your Timeline Settings:</h3>
          <ul>
            <li><strong>Project Duration:</strong> 2 months</li>
            <li><strong>Notification Frequency:</strong> Bi-weekly</li>
            <li><strong>Selected Categories:</strong> Plumbing, Electrical, General Contractor</li>
          </ul>
        </div>

        <div class="next-steps">
          <h3>🚀 What's Next:</h3>
          <p>You'll receive targeted promotional offers based on your timeline:</p>
          <ul>
            <li>Week 1-2: Planning phase offers (consultations, estimates)</li>
            <li>Week 3-6: Active project offers (materials, services)</li>
            <li>Week 7-8: Completion phase offers (finishing touches, warranties)</li>
          </ul>
        </div>

        <p>You can update your timeline preferences anytime in your dashboard.</p>
        
        <div class="email-footer">
          <p>Best regards,<br>Business Directory Team</p>
        </div>
      </div>
    `;
  }

  getEmailIcon(type) {
    const icons = {
      promotional: 'fa-tags',
      system: 'fa-cog',
      timeline: 'fa-calendar-alt'
    };
    return icons[type] || 'fa-envelope';
  }

  getTimeAgo(timestamp) {
    const now = new Date();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
    if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    return 'Just now';
  }

  handleEmailClick(e) {
    const emailItem = e.target.closest('.email-item');
    const action = e.target.closest('[data-action]')?.dataset.action;
    
    if (!emailItem) return;

    const emailId = emailItem.dataset.emailId;

    switch(action) {
      case 'read':
        this.markEmailAsRead(emailId, emailItem);
        break;
      case 'delete':
        this.deleteEmail(emailId, emailItem);
        break;
      case 'view':
        this.viewFullEmail(emailId);
        break;
      default:
        // Click on email item itself - mark as read and preview
        this.markEmailAsRead(emailId, emailItem);
        break;
    }
  }

  markEmailAsRead(emailId, emailItem) {
    emailItem.classList.remove('unread');
    const readBtn = emailItem.querySelector('.read-btn');
    if (readBtn) {
      readBtn.innerHTML = '<i class="fas fa-check"></i> Read';
      readBtn.disabled = true;
    }
    
    // Update unread count
    this.updateUnreadCount();
    
    this.showToast('Email marked as read', 'success');
  }

  deleteEmail(emailId, emailItem) {
    emailItem.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => {
      emailItem.remove();
      this.updateUnreadCount();
      this.showToast('Email deleted', 'info');
    }, 300);
  }

  viewFullEmail(emailId) {
    // Create modal for full email view
    const modal = this.createEmailModal(emailId);
    document.body.appendChild(modal);
    modal.classList.add('active');
  }

  createEmailModal(emailId) {
    // This would typically fetch the full email content
    const modal = document.createElement('div');
    modal.className = 'email-modal';
    modal.innerHTML = `
      <div class="email-modal-content">
        <div class="email-modal-header">
          <h3>Email Details</h3>
          <button class="close-modal-btn" onclick="this.closest('.email-modal').remove()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="email-modal-body">
          <div class="email-full-display">
            <!-- Full email content would be loaded here -->
            <p>Loading full email content...</p>
          </div>
        </div>
        <div class="email-modal-footer">
          <button class="primary-button" onclick="this.closest('.email-modal').remove()">
            Close
          </button>
        </div>
      </div>
    `;
    return modal;
  }

  updateInboxStats(emails) {
    const unreadCount = emails.filter(email => !email.isRead).length;
    const totalCount = emails.length;
    
    // Update unread badges
    document.querySelectorAll('.inbox-badge, #unread-count').forEach(badge => {
      badge.textContent = unreadCount;
      badge.style.display = unreadCount > 0 ? 'flex' : 'none';
    });

    // Update unread emails stat
    const unreadStat = document.getElementById('unread-emails');
    if (unreadStat) {
      unreadStat.textContent = unreadCount;
    }

    // Update inbox summary
    const inboxSummary = document.querySelector('.inbox-summary');
    if (inboxSummary) {
      inboxSummary.innerHTML = `
        <div class="inbox-stat">
          <i class="fas fa-envelope"></i>
          <span>Total: <strong>${totalCount}</strong></span>
        </div>
        <div class="inbox-stat">
          <i class="fas fa-envelope-open"></i>
          <span>Unread: <strong>${unreadCount}</strong></span>
        </div>
        <div class="inbox-stat">
          <i class="fas fa-tags"></i>
          <span>Promotional: <strong>${emails.filter(e => e.type === 'promotional').length}</strong></span>
        </div>
      `;
    }
  }

  updateUnreadCount() {
    const unreadEmails = document.querySelectorAll('.email-item.unread').length;
    
    document.querySelectorAll('.inbox-badge, #unread-count').forEach(badge => {
      badge.textContent = unreadEmails;
      badge.style.display = unreadEmails > 0 ? 'flex' : 'none';
    });

    const unreadStat = document.getElementById('unread-emails');
    if (unreadStat) {
      unreadStat.textContent = unreadEmails;
    }
  }

  filterInboxEmails(filter) {
    const emails = document.querySelectorAll('.email-item');
    const filterButtons = document.querySelectorAll('.inbox-filter-btn');
    
    // Update active filter button
    filterButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.filter === filter);
    });

    // Filter emails
    emails.forEach(email => {
      const emailType = email.querySelector('.email-content').dataset.type || 'promotional';
      
      if (filter === 'all' || emailType === filter) {
        email.style.display = 'flex';
      } else {
        email.style.display = 'none';
      }
    });
  }

  addMockEmail(emailData) {
    const emailContainer = document.querySelector('.email-list');
    if (!emailContainer) return;

    const newEmail = {
      id: Date.now(),
      isRead: false,
      ...emailData
    };

    const emailHTML = this.createEmailItem(newEmail);
    emailContainer.insertAdjacentHTML('afterbegin', emailHTML);
    
    this.updateUnreadCount();
  }

  // Offers Management (existing code)
  initializeOfferFilters() {
    // Setup search
    const filtersContainer = document.querySelector('.filters-container');
    if (filtersContainer && !document.getElementById('offer-search')) {
      const searchDiv = document.createElement('div');
      searchDiv.className = 'search-container';
      searchDiv.innerHTML = `
        <input type="text" id="offer-search" placeholder="Search offers..." aria-label="Search offers">
        <button id="search-button" aria-label="Search">
          <i class="fas fa-search"></i>
        </button>
      `;
      filtersContainer.insertBefore(searchDiv, filtersContainer.firstChild);
    }

    // Bind filter events
    const searchButton = document.getElementById('search-button');
    const searchInput = document.getElementById('offer-search');
    const filterElements = [
      'category-filter', 'date-filter', 'discount-filter', 'active-filter'
    ].map(id => document.getElementById(id)).filter(Boolean);

    if (searchButton) {
      searchButton.addEventListener('click', () => this.loadOffers());
    }

    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => this.loadOffers(), 300);
      });
    }

    filterElements.forEach(element => {
      element.addEventListener('change', () => this.loadOffers());
    });

    // Quick filters
    document.querySelectorAll('.quick-filter-button').forEach(button => {
      button.addEventListener('click', () => {
        const categoryFilter = document.getElementById('category-filter');
        if (categoryFilter) {
          categoryFilter.value = button.dataset.category;
          this.loadOffers();
        }
      });
    });
  }

  async loadOffers() {
    const offersContainer = document.querySelector('.offers-container');
    if (!offersContainer) return;

    // Show loading state
    offersContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading offers...</div>';

    // Get filter values
    const params = new URLSearchParams({
      category: document.getElementById('category-filter')?.value || 'all',
      date: document.getElementById('date-filter')?.value || 'newest',
      discount: document.getElementById('discount-filter')?.value || 'highest',
      active_only: document.getElementById('active-filter')?.checked || true,
      search: document.getElementById('offer-search')?.value || ''
    });

    try {
      const response = await fetch(`{% url 'filter_offers' %}?${params}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      const data = await response.json();
      
      // Update stats
      document.getElementById('total-offers').textContent = data.total_offers;
      document.getElementById('active-offers').textContent = data.total_offers;
      document.getElementById('expiring-soon').textContent = data.expiring_soon_count;
      
      // Render offers
      this.renderOffers(data.offers);
    } catch (error) {
      console.error('Error loading offers:', error);
      offersContainer.innerHTML = '<div class="error"><i class="fas fa-exclamation-circle"></i> Failed to load offers. Please try again.</div>';
    }
  }

  renderOffers(offers) {
    const offersContainer = document.querySelector('.offers-container');
    if (!offersContainer) return;

    if (!offers || offers.length === 0) {
      offersContainer.innerHTML = `
        <div class="empty-offers">
          <div class="empty-state-illustration">
            <i class="fas fa-tags"></i>
          </div>
          <h3>No promotional offers found</h3>
          <p>Try adjusting your filters or check back later for new offers!</p>
        </div>
      `;
      return;
    }

    offersContainer.innerHTML = offers.map(offer => this.createOfferCard(offer)).join('');
    
    // Bind card flip events
    offersContainer.querySelectorAll('.offer-card').forEach(card => {
      const viewBtn = card.querySelector('.view-details-button');
      const backBtn = card.querySelector('.back-to-front-button');
      const inner = card.querySelector('.offer-card-inner');
      
      viewBtn.addEventListener('click', () => inner.classList.add('flipped'));
      backBtn.addEventListener('click', () => inner.classList.remove('flipped'));
    });
  }

  createOfferCard(offer) {
    const categoryTags = offer.categories.map(cat => 
      `<span class="category-tag">${cat}</span>`
    ).join('');
    
    const classes = ['offer-card'];
    if (offer.expiring_soon) classes.push('expiring-soon');
    if (offer.categories_match_preferences) classes.push('matches-preferences');
    
    return `
      <div class="${classes.join(' ')}">
        <div class="offer-card-inner">
          <div class="offer-card-front">
            <div class="business-card">
              <div class="business-logo">
                <i class="fas fa-wrench"></i>
              </div>
              <h3 class="business-name">${offer.business_name}</h3>
              <p class="business-title">Professional Services</p>
              <p class="business-contact">${offer.business_phone || 'Contact for details'}</p>
            </div>
            <div class="offer-badge">
              <div class="discount-percentage">${offer.discount_percentage}%</div>
              <div class="discount-label">OFF</div>
            </div>
            <div class="offer-dates">
              <span class="valid-label">Valid:</span> ${offer.start_date} - ${offer.end_date}
            </div>
            <div class="offer-code-container">
              <span class="offer-code-label">Code:</span>
              <span class="offer-code">${offer.code}</span>
            </div>
            <div class="offer-categories">
              ${categoryTags}
            </div>
            <button class="view-details-button">View Details</button>
          </div>
          <div class="offer-card-back">
            <div class="offer-details">
              <h3>${offer.title || 'Offer Details'}</h3>
              <p>${offer.description}</p>
              <div class="business-details">
                <div class="detail-item">
                  <i class="fas fa-user"></i>
                  <span>${offer.business_name}</span>
                </div>
                ${offer.business_phone ? `
                  <div class="detail-item">
                    <i class="fas fa-phone"></i>
                    <span>${offer.business_phone}</span>
                  </div>
                ` : ''}
                ${offer.business_email ? `
                  <div class="detail-item">
                    <i class="fas fa-envelope"></i>
                    <span>${offer.business_email}</span>
                  </div>
                ` : ''}
                ${offer.business_address ? `
                  <div class="detail-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${offer.business_address}</span>
                  </div>
                ` : ''}
              </div>
              <div class="countdown-container">
                <div class="countdown-label">Expires in:</div>
                <div class="countdown">${offer.days_until_expiry} days</div>
              </div>
            </div>
            <button class="back-to-front-button">
              <i class="fas fa-arrow-left"></i> Back
            </button>
          </div>
        </div>
      </div>
    `;
  }

  // Notification Settings
  initializeNotificationSettings() {
    const notificationSlider = document.getElementById('notification-limit');
    const sliderValue = document.getElementById('slider-value');
    
    if (notificationSlider && sliderValue) {
      sliderValue.textContent = notificationSlider.value;
      notificationSlider.addEventListener('input', function() {
        sliderValue.textContent = this.value;
      });
    }
  }

  async loadNotificationSettings() {
    try {
      const response = await fetch('{% url "user_notifications" %}', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      const data = await response.json();
      
      // Set form values
      if (data.notification_preference) {
        const radio = document.querySelector(`input[name="notification_preference"][value="${data.notification_preference}"]`);
        if (radio) radio.checked = true;
      }
      
      const minDiscount = document.querySelector('select[name="min_discount"]');
      if (minDiscount && data.min_discount) {
        minDiscount.value = data.min_discount;
      }
      
      const timePeriod = document.querySelector('select[name="time_period"]');
      if (timePeriod && data.time_period) {
        timePeriod.value = data.time_period;
      }
      
      const notificationLimit = document.getElementById('notification-limit');
      if (notificationLimit && data.notification_limit) {
        notificationLimit.value = data.notification_limit;
        const sliderValue = document.getElementById('slider-value');
        if (sliderValue) sliderValue.textContent = data.notification_limit;
      }
      
      if (data.email_format) {
        const emailFormat = document.querySelector(`input[name="email_format"][value="${data.email_format}"]`);
        if (emailFormat) emailFormat.checked = true;
      }
    } catch (error) {
      console.error('Error loading notification settings:', error);
      this.showToast('Error loading notification settings', 'error');
    }
  }

  // Utility Methods
  showToast(message, type = 'info') {
    if (typeof Toastify !== 'undefined') {
      Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: {
          success: "#28a745",
          error: "#dc3545",
          warning: "#ffc107",
          info: "#17a2b8"
        }[type] || "#17a2b8",
        className: "toast-" + type,
        stopOnFocus: true
      }).showToast();
    } else {
      // Fallback to console if Toastify not available
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
  }

  updateLastUpdated() {
    const timestamp = document.getElementById('last-updated-timestamp');
    if (timestamp) {
      const now = new Date();
      timestamp.textContent = now.toLocaleString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        hour12: true
      });
    }
  }

  updateWelcomeName(firstName) {
    const nameElement = document.getElementById('user-first-name');
    if (nameElement && firstName) {
      nameElement.textContent = firstName;
    }
  }
}

// Initialize dashboard when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  window.dashboard = new DashboardManager();
});

// Handle browser back/forward for tabs
window.addEventListener('hashchange', () => {
  const hash = window.location.hash.replace('#', '');
  if (hash && window.dashboard) {
    window.dashboard.switchTab(hash);
  }
});
</script>
{% endblock %}