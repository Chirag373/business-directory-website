{% extends "base.html" %}
{% load static %}

{% block title %}Consumer Dashboard - Business Directory 2.0{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/consumer_dashboard.css' %}">
{% endblock %}

{% block content %}
<main class="consumer-dashboard">
  <!-- Header Section -->
  <header class="dashboard-header">
    <h1>Welcome, <span id="user-first-name">{{ user.first_name }}</span></h1>
    <div class="logout-container">
      <a href="{% url 'logout' %}" class="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</a>
      <button class="dashboard-hamburger" aria-label="Toggle dashboard menu">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Dashboard Tabs -->
  <div class="dashboard-tabs">
    <button class="tab-button active" data-tab="profile">
      <i class="fas fa-user"></i> My Profile
    </button>
    <button class="tab-button" data-tab="preferences">
      <i class="fas fa-sliders-h"></i> Service Preferences
    </button>
    <button class="tab-button" data-tab="offers">
      <i class="fas fa-tags"></i> Promotional Offers
    </button>
    <button class="tab-button" data-tab="notifications">
      <i class="fas fa-bell"></i> Notification Settings
    </button>
  </div>

  <!-- Mobile Dashboard Sidebar -->
  <div class="dashboard-sidebar">
    <div class="sidebar-header">
      <h3>Dashboard Menu</h3>
      <button class="close-sidebar" aria-label="Close menu">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <button class="sidebar-tab-button active" data-tab="profile">
          <i class="fas fa-user"></i> My Profile
        </button>
      </li>
      <li>
        <button class="sidebar-tab-button" data-tab="preferences">
          <i class="fas fa-sliders-h"></i> Service Preferences
        </button>
      </li>
      <li>
        <button class="sidebar-tab-button" data-tab="offers">
          <i class="fas fa-tags"></i> Promotional Offers
        </button>
      </li>
      <li>
        <button class="sidebar-tab-button" data-tab="notifications">
          <i class="fas fa-bell"></i> Notification Settings
        </button>
      </li>
    </ul>
  </div>

  <!-- Dashboard Sidebar Overlay -->
  <div class="dashboard-overlay"></div>

  <!-- Dashboard Stats -->
  <div class="dashboard-stats">
    <div class="stat-card">
      <div class="stat-number" id="total-offers">{{ total_offers|default:"0" }}</div>
      <div class="stat-label">Total Offers</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="active-offers">{{ active_offers|default:"0" }}</div>
      <div class="stat-label">Active Offers</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="expiring-soon">{{ expiring_soon|default:"0" }}</div>
      <div class="stat-label">Expiring Soon</div>
    </div>
  </div>

  <!-- Tab Content -->
  <section class="dashboard-content active" id="profile-section">
    {% include "users/consumer_dashboard_profile.html" %}
  </section>
  <section class="dashboard-content" id="preferences-section">
    {% include "users/consumer_dashboard_preferences.html" %}
  </section>
  <section class="dashboard-content" id="offers-section">
    {% include "users/consumer_dashboard_offers.html" %}
  </section>
  <section class="dashboard-content" id="notifications-section">
    {% include "users/consumer_dashboard_notifications.html" %}
  </section>
</main>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // -----------------------
    // Tab Navigation System
    // -----------------------
    
    // Handle tab switching
    const tabButtons = document.querySelectorAll('.tab-button, .sidebar-tab-button');
    const tabSections = document.querySelectorAll('.dashboard-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Remove active class from all buttons and sections
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabSections.forEach(section => section.classList.remove('active'));
        
        // Add active class to clicked button and corresponding section
        this.classList.add('active');
        const tabName = this.dataset.tab;
        document.getElementById(`${tabName}-section`).classList.add('active');
        
        // For mobile: close sidebar when a tab is selected
        document.querySelector('.dashboard-sidebar').classList.remove('open');
        document.querySelector('.dashboard-overlay').classList.remove('active');
        
        // Load tab-specific data
        if (tabName === 'offers') {
          loadOffers();
        } else if (tabName === 'notifications') {
          loadNotificationSettings();
        }
      });
    });
    
    // Mobile menu toggle
    document.querySelector('.dashboard-hamburger').addEventListener('click', function() {
      document.querySelector('.dashboard-sidebar').classList.add('open');
      document.querySelector('.dashboard-overlay').classList.add('active');
    });
    
    document.querySelector('.close-sidebar').addEventListener('click', function() {
      document.querySelector('.dashboard-sidebar').classList.remove('open');
      document.querySelector('.dashboard-overlay').classList.remove('active');
    });
    
    document.querySelector('.dashboard-overlay').addEventListener('click', function() {
      document.querySelector('.dashboard-sidebar').classList.remove('open');
      this.classList.remove('active');
    });
    
    // -----------------------
    // Profile Tab Functions
    // -----------------------
    
    // Initialize the profile form data
    function initializeProfile() {
      const stateSelect = document.getElementById('state');
      if (stateSelect && stateSelect.options.length <= 1) {
        const states = {
          'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
          'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
          'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii', 'ID': 'Idaho',
          'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas',
          'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
          'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
          'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada',
          'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico', 'NY': 'New York',
          'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio', 'OK': 'Oklahoma',
          'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
          'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
          'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia',
          'WI': 'Wisconsin', 'WY': 'Wyoming'
        };
        
        Object.entries(states).forEach(([code, name]) => {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = name;
          stateSelect.appendChild(option);
        });
        
        // Set the current state if any
        const currentState = "{{ user.address.state|default:'' }}";
        if (currentState) {
          stateSelect.value = currentState;
          // Enable county dropdown
          document.getElementById('county').disabled = false;
        }
      }
      
      // Calculate profile completion
      calculateProfileCompletion();
    }
    
    // Calculate profile completion percentage
    function calculateProfileCompletion() {
      const requiredFields = [
        document.getElementById('first-name')?.value || '',
        document.getElementById('last-name')?.value || '',
        document.getElementById('email')?.value || '',
        document.getElementById('phone')?.value || '',
        document.getElementById('address-number')?.value || '',
        document.getElementById('address-street')?.value || '',
        document.getElementById('state')?.value || '',
        document.getElementById('city')?.value || '',
        document.getElementById('zip')?.value || ''
      ];
      
      const filledFields = requiredFields.filter(field => field && field.trim() !== '').length;
      const completionPercentage = Math.round((filledFields / requiredFields.length) * 100);
      
      // Update the progress bar
      const progressBar = document.getElementById('profile-progress');
      const percentageText = document.querySelector('.completion-percentage');
      
      if (progressBar) progressBar.style.width = `${completionPercentage}%`;
      if (percentageText) percentageText.textContent = `${completionPercentage}%`;
    }
    
    // Handle state-county-city dependencies
    const stateSelect = document.getElementById('state');
    if (stateSelect) {
      stateSelect.addEventListener('change', function() {
        const countySelect = document.getElementById('county');
        countySelect.disabled = !this.value;
        countySelect.innerHTML = '<option value="">Select a County</option>';
        
        const citySelect = document.getElementById('city');
        citySelect.disabled = true;
        citySelect.innerHTML = '<option value="">Select a City</option>';
        
        if (this.value) {
          // In a real application, you would make an AJAX call here to get counties
          // For this example, we'll simulate with dummy data
          const dummyCounties = ['County 1', 'County 2', 'County 3'];
          dummyCounties.forEach(county => {
            const option = document.createElement('option');
            option.value = county;
            option.textContent = county;
            countySelect.appendChild(option);
          });
        }
      });
    }
    
    const countySelect = document.getElementById('county');
    if (countySelect) {
      countySelect.addEventListener('change', function() {
        const citySelect = document.getElementById('city');
        citySelect.disabled = !this.value;
        citySelect.innerHTML = '<option value="">Select a City</option>';
        
        if (this.value) {
          // In a real application, you would make an AJAX call here to get cities
          // For this example, we'll simulate with dummy data
          const dummyCities = ['City 1', 'City 2', 'City 3'];
          dummyCities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
          });
        }
      });
    }
    
    // Profile form submission
    const profileForm = document.querySelector('.profile-form');
    if (profileForm) {
      profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(this);
        
        // Send AJAX request
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Show success notification
            showToast(data.message, 'success');
            
            // Update the last updated timestamp
            const now = new Date();
            const lastUpdatedEl = document.getElementById('last-updated-timestamp');
            if (lastUpdatedEl) {
              lastUpdatedEl.textContent = now.toLocaleString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
              });
            }
            
            // Update first name in welcome message if changed
            const firstName = document.getElementById('first-name').value;
            const userNameEl = document.getElementById('user-first-name');
            if (userNameEl) userNameEl.textContent = firstName;
            
            // Recalculate profile completion
            calculateProfileCompletion();
          } else if (data.status === 'error') {
            // Show error notification
            showToast(data.message, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('An error occurred while updating profile', 'error');
        });
      });
    }
    
    // -----------------------
    // Preferences Tab Functions
    // -----------------------
    
    // Handle AJAX form submission for preferences
    const preferencesForm = document.querySelector('.preferences-form');
    if (preferencesForm) {
      preferencesForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(this);
        
        // Send AJAX request
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            showToast(data.message, 'success');
          } else if (data.status === 'error') {
            showToast(data.message, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('An error occurred while updating preferences', 'error');
        });
      });
    }
    
    // -----------------------
    // Offers Tab Functions
    // -----------------------
    
    // Load offers data
    function loadOffers() {
      const offersContainer = document.querySelector('.offers-container');
      if (!offersContainer) return;
      
      // Show loading state
      offersContainer.innerHTML = '<div class="loading">Loading offers...</div>';
      
      // Get filter values
      const categoryFilter = document.getElementById('category-filter')?.value || '';
      const dateFilter = document.getElementById('date-filter')?.value || 'newest';
      const discountFilter = document.getElementById('discount-filter')?.value || 'highest';
      const activeOnly = document.getElementById('active-filter')?.checked || true;
      const searchValue = document.getElementById('offer-search')?.value || '';
      
      // Make API call to get offers
      fetch(`{% url 'filter_offers' %}?category=${categoryFilter}&date=${dateFilter}&discount=${discountFilter}&active_only=${activeOnly}&search=${searchValue}`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        // Update stats
        document.getElementById('total-offers').textContent = data.total_offers;
        document.getElementById('active-offers').textContent = data.total_offers;
        document.getElementById('expiring-soon').textContent = data.expiring_soon_count;
        
        // Render offers
        renderOffers(data.offers);
      })
      .catch(error => {
        console.error('Error loading offers:', error);
        offersContainer.innerHTML = '<div class="error">Failed to load offers. Please try again.</div>';
      });
    }
    
    // Render offers from data
    function renderOffers(offers) {
      const offersContainer = document.querySelector('.offers-container');
      if (!offersContainer) return;
      
      // Clear container
      offersContainer.innerHTML = '';
      
      // Show empty state if no offers
      if (!offers || offers.length === 0) {
        offersContainer.innerHTML = `
          <div class="empty-offers">
            <div class="empty-state-illustration">
              <i class="fas fa-tags"></i>
            </div>
            <h3>No promotional offers match your filters</h3>
            <p>Try adjusting your filter criteria or check back later for new offers!</p>
          </div>
        `;
        return;
      }
      
      // Create offer cards
      offers.forEach(offer => {
        const categoryTags = offer.categories.map(cat => 
          `<span class="category-tag">${typeof cat === 'string' ? cat : cat.name}</span>`
        ).join('');
        
        const expiryClass = offer.expiring_soon ? 'expiring-soon' : '';
        const matchesPreferences = offer.categories_match_preferences ? 'matches-preferences' : '';
        
        const offerCard = document.createElement('div');
        offerCard.className = `offer-card ${expiryClass} ${matchesPreferences}`;
        offerCard.innerHTML = `
          <div class="offer-card-inner">
            <div class="offer-card-front">
              <div class="business-card">
                <div class="business-logo">
                  <i class="fas fa-wrench"></i>
                </div>
                <h3 class="business-name">${offer.business_name}</h3>
                <p class="business-title">Professional Services</p>
                <p class="business-contact">${offer.business_phone}</p>
              </div>
              <div class="offer-badge">
                <div class="discount-percentage">${offer.discount_percentage}%</div>
                <div class="discount-label">OFF</div>
              </div>
              <div class="offer-dates">
                <span class="valid-label">Valid:</span> ${offer.start_date} - ${offer.end_date}
              </div>
              <div class="offer-code-container">
                <span class="offer-code-label">Code:</span>
                <span class="offer-code">${offer.code}</span>
              </div>
              <div class="offer-categories">
                ${categoryTags}
              </div>
              <button class="view-details-button">View Details</button>
            </div>
            <div class="offer-card-back">
              <div class="offer-details">
                <h3>${offer.title || 'Offer Details'}</h3>
                <p>${offer.description}</p>
                <div class="business-details">
                  <div class="detail-item">
                    <i class="fas fa-user"></i>
                    <span>Business Owner</span>
                  </div>
                  <div class="detail-item">
                    <i class="fas fa-phone"></i>
                    <span>${offer.business_phone}</span>
                  </div>
                  <div class="detail-item">
                    <i class="fas fa-envelope"></i>
                    <span>${offer.business_email}</span>
                  </div>
                  <div class="detail-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${offer.business_address}</span>
                  </div>
                </div>
                <div class="countdown-container">
                  <div class="countdown-label">Expires in:</div>
                  <div class="countdown">${offer.days_until_expiry} days</div>
                </div>
              </div>
              <button class="back-to-front-button">
                <i class="fas fa-arrow-left"></i> Back
              </button>
            </div>
          </div>
        `;
        offersContainer.appendChild(offerCard);
        
        // Add flip card functionality
        const viewDetailsBtn = offerCard.querySelector('.view-details-button');
        const backToFrontBtn = offerCard.querySelector('.back-to-front-button');
        
        viewDetailsBtn.addEventListener('click', () => {
          offerCard.querySelector('.offer-card-inner').classList.add('flipped');
        });
        
        backToFrontBtn.addEventListener('click', () => {
          offerCard.querySelector('.offer-card-inner').classList.remove('flipped');
        });
      });
    }
    
    // Add search input to offers container and set up filter handlers
    function setupOffersFiltering() {
      // Add search input
      const filtersContainer = document.querySelector('.filters-container');
      if (filtersContainer && !document.getElementById('offer-search')) {
        const searchDiv = document.createElement('div');
        searchDiv.className = 'search-container';
        searchDiv.innerHTML = `
          <input type="text" id="offer-search" placeholder="Search offers...">
          <button id="search-button"><i class="fas fa-search"></i></button>
        `;
        filtersContainer.insertBefore(searchDiv, filtersContainer.firstChild);
        
        // Add event listener for search button
        document.getElementById('search-button').addEventListener('click', loadOffers);
        
        // Add debounced input event for search
        const searchInput = document.getElementById('offer-search');
        let searchTimeout;
        searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(loadOffers, 300); // 300ms debounce
        });
      }
      
      // Set up filter change handlers
      const filterElements = [
        document.getElementById('category-filter'),
        document.getElementById('date-filter'),
        document.getElementById('discount-filter'),
        document.getElementById('active-filter')
      ];
      
      filterElements.forEach(element => {
        if (element) element.addEventListener('change', loadOffers);
      });
      
      // Set up quick filter buttons
      const quickFilterButtons = document.querySelectorAll('.quick-filter-button');
      quickFilterButtons.forEach(button => {
        button.addEventListener('click', () => {
          const category = button.dataset.category;
          const categoryFilter = document.getElementById('category-filter');
          if (categoryFilter) {
            categoryFilter.value = category;
            loadOffers();
          }
        });
      });
    }
    
    // -----------------------
    // Notifications Tab Functions
    // -----------------------
    
    // Load notification settings from API
    function loadNotificationSettings() {
      const notificationForm = document.querySelector('.notification-form');
      if (!notificationForm) return;
      
      // Fetch current notification settings
      fetch('{% url "user_notifications" %}', {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        // Set radio button values
        const notificationPreference = document.querySelector(`input[name="notification_preference"][value="${data.notification_preference}"]`);
        if (notificationPreference) notificationPreference.checked = true;
        
        // Set dropdown values
        const minDiscount = document.querySelector('select[name="min_discount"]');
        if (minDiscount) minDiscount.value = data.min_discount;
        
        const timePeriod = document.querySelector('select[name="time_period"]');
        if (timePeriod) timePeriod.value = data.time_period;
        
        // Set slider value
        const notificationLimit = document.getElementById('notification-limit');
        const sliderValue = document.getElementById('slider-value');
        if (notificationLimit) {
          notificationLimit.value = data.notification_limit;
          if (sliderValue) sliderValue.textContent = data.notification_limit;
        }
        
        // Set email format
        const emailFormat = document.querySelector(`input[name="email_format"][value="${data.email_format}"]`);
        if (emailFormat) emailFormat.checked = true;
      })
      .catch(error => {
        console.error('Error loading notification settings:', error);
        showToast('Error loading notification settings', 'error');
      });
    }
    
    // Handle notification settings form submission
    const notificationForm = document.querySelector('.notification-form');
    if (notificationForm) {
      notificationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(this);
        
        // Send AJAX request
        fetch('{% url "user_notifications" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            showToast(data.message, 'success');
          } else {
            showToast('An error occurred while updating notification settings', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('An error occurred while updating notification settings', 'error');
        });
      });
    }
    
    // Initialize notification slider value display
    const notificationSlider = document.getElementById('notification-limit');
    if (notificationSlider) {
      const sliderValue = document.getElementById('slider-value');
      if (sliderValue) sliderValue.textContent = notificationSlider.value;
      
      notificationSlider.addEventListener('input', function() {
        if (sliderValue) sliderValue.textContent = this.value;
      });
    }
    
    // -----------------------
    // Utility Functions
    // -----------------------
    
    // Helper function for displaying toasts
    function showToast(message, type) {
      if (typeof Toastify === 'undefined') {
        console.log(message);
        return;
      }
      
      Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: type === 'success' ? "#4CAF50" : 
                        type === 'error' ? "#F44336" : 
                        type === 'info' ? "#2196F3" : "#FF9800"
      }).showToast();
    }
    
    // -----------------------
    // Initialization
    // -----------------------
    
    // Initialize everything
    function init() {
      // Initialize profile tab
      initializeProfile();
      
      // Setup offers filtering
      setupOffersFiltering();
      
      // Check which tab is active and load appropriate data
      if (document.querySelector('.tab-button[data-tab="offers"].active')) {
        loadOffers();
      } else if (document.querySelector('.tab-button[data-tab="notifications"].active')) {
        loadNotificationSettings();
      }
    }
    
    // Run initialization
    init();
  });
</script>
{% endblock %} 