{% extends "base.html" %}
{% load static %}

{% block title %}Services Management - Handyman Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/handyman_dashboard.css' %}">
<style>
  .service-section {
    background-color: var(--card-bg-color);
    border-radius: 8px;
    padding: 20px;
    box-shadow: var(--box-shadow);
    margin-bottom: 20px;
  }
  
  .service-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: var(--dark-color);
    font-size: 1.3rem;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
  }
  
  .service-description-display {
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
  }
  
  .service-description-display p {
    margin-bottom: 15px;
    color: var(--dark-color);
  }
  
  .services-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  
  .services-table-header {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    background-color: #f5f5f5;
    padding: 10px;
    border-radius: 4px 4px 0 0;
    font-weight: 600;
    color: var(--dark-color);
  }
  
  .services-table-body {
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 4px 4px;
  }
  
  .service-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    padding: 12px 10px;
    border-bottom: 1px solid var(--border-color);
    align-items: center;
  }
  
  .service-row:last-child {
    border-bottom: none;
  }
  
  .service-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  .action-button {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-size: 1rem;
    padding: 5px;
  }
  
  .action-button.delete {
    color: var(--danger-color);
  }
  
  .input-with-symbol {
    position: relative;
  }
  
  .input-symbol {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary-color);
  }
  
  .input-with-symbol input {
    padding-left: 25px;
  }
  
  .character-count {
    text-align: right;
    font-size: 0.8rem;
    color: var(--secondary-color);
    margin-top: 5px;
  }
  
  .add-button {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    background-color: var(--primary-color);
    color: white;
    border-radius: var(--border-radius);
    text-decoration: none;
    font-weight: 500;
    transition: var(--transition);
    border: none;
    cursor: pointer;
  }
  
  .add-button i {
    margin-right: 5px;
  }
  
  .dashboard-form {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 4px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 5px;
    color: var(--dark-color);
    font-weight: 500;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 1rem;
  }
  
  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }
  
  .form-row {
    display: flex;
    gap: 20px;
  }
  
  .form-row .form-group {
    flex: 1;
  }
  
  .form-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
  }
  
  .btn {
    padding: 8px 16px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-weight: 500;
  }
  
  .btn-primary {
    background-color: var(--primary-color);
    color: white;
  }
  
  .btn-secondary {
    background-color: var(--secondary-color);
    color: white;
  }
  
  .success {
    color: var(--success-color);
    margin-left: 10px;
  }
  
  .error {
    color: var(--danger-color);
    margin-left: 10px;
  }
  
  @media (max-width: 768px) {
    .services-table-header,
    .service-row {
      grid-template-columns: 2fr 1fr 1fr;
    }
    
    .service-actions {
      grid-column: 1 / -1;
      justify-content: flex-start;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
    }
    
    .form-row {
      flex-direction: column;
      gap: 0;
    }
  }
</style>
{% endblock %}

{% block content %}
<main class="handyman-dashboard">
  <!-- Header Section -->
  <header class="dashboard-header">
    <div class="header-left">
      <h1>Welcome, <span id="business-name">{{ user.business_name }}</span></h1>
      <div class="profile-completion">
        <div class="completion-label">Profile Completion:</div>
        <div class="progress-container">
          <div class="progress-bar" id="profile-progress" style="width: 75%;"></div>
        </div>
        <div class="completion-percentage">75%</div>
      </div>
    </div>
    <div class="header-right">
      <div class="logout-container">
        <a href="{% url 'logout' %}" class="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</a>
        <button class="dashboard-hamburger" aria-label="Toggle dashboard menu">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Dashboard Tabs -->
  <div class="dashboard-tabs">
    <a href="{% url 'handyman_dashboard' %}" class="tab-button {% if request.resolver_match.url_name == 'handyman_dashboard' %}active{% endif %}">
      <i class="fas fa-home"></i> Overview
    </a>
    <a href="{% url 'handyman_dashboard_promotions' %}" class="tab-button {% if request.resolver_match.url_name == 'handyman_dashboard_promotions' %}active{% endif %}">
      <i class="fas fa-tags"></i> Promotions
    </a>
    <a href="{% url 'handyman_dashboard_services' %}" class="tab-button {% if request.resolver_match.url_name == 'handyman_dashboard_services' %}active{% endif %}">
      <i class="fas fa-tools"></i> Services
    </a>
    <a href="{% url 'handyman_dashboard_jobs' %}" class="tab-button {% if request.resolver_match.url_name == 'handyman_dashboard_jobs' %}active{% endif %}">
      <i class="fas fa-hammer"></i> Jobs
    </a>
    <a href="{% url 'handyman_dashboard_profile' %}" class="tab-button {% if request.resolver_match.url_name == 'handyman_dashboard_profile' %}active{% endif %}">
      <i class="fas fa-user-circle"></i> Profile
    </a>
  </div>

  <!-- Mobile Dashboard Sidebar -->
  <div class="dashboard-sidebar">
    <div class="sidebar-header">
      <h3>Dashboard Menu</h3>
      <button class="close-sidebar" aria-label="Close menu">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <a href="{% url 'handyman_dashboard' %}" class="sidebar-tab-button {% if request.resolver_match.url_name == 'handyman_dashboard' %}active{% endif %}">
          <i class="fas fa-home"></i> Overview
        </a>
      </li>
      <li>
        <a href="{% url 'handyman_dashboard_promotions' %}" class="sidebar-tab-button {% if request.resolver_match.url_name == 'handyman_dashboard_promotions' %}active{% endif %}">
          <i class="fas fa-tags"></i> Promotions
        </a>
      </li>
      <li>
        <a href="{% url 'handyman_dashboard_services' %}" class="sidebar-tab-button {% if request.resolver_match.url_name == 'handyman_dashboard_services' %}active{% endif %}">
          <i class="fas fa-tools"></i> Services
        </a>
      </li>
      <li>
        <a href="{% url 'handyman_dashboard_jobs' %}" class="sidebar-tab-button {% if request.resolver_match.url_name == 'handyman_dashboard_jobs' %}active{% endif %}">
          <i class="fas fa-hammer"></i> Jobs
        </a>
      </li>
      <li>
        <a href="{% url 'handyman_dashboard_profile' %}" class="sidebar-tab-button {% if request.resolver_match.url_name == 'handyman_dashboard_profile' %}active{% endif %}">
          <i class="fas fa-user-circle"></i> Profile
        </a>
      </li>
    </ul>
  </div>

  <!-- Dashboard Sidebar Overlay -->
  <div class="dashboard-overlay"></div>

  <!-- Services Content -->
  <div class="dashboard-content">
    <h2>Services Management</h2>
    
    <!-- Service Description Section -->
    <div class="service-section">
      <h3>Your Service Description</h3>
      <div class="service-description-container">
        <div class="service-description-display">
          <p id="current-service-description">{{ service_description|default:"No service description available." }}</p>
          <button class="edit-button" id="edit-description-button">
            <i class="fas fa-edit"></i> Edit Description
          </button>
        </div>
        <div class="service-description-form" style="display: none;">
          <form id="service-description-form">
            {% csrf_token %}
            <div class="form-group">
              <label for="service-description">Service Description</label>
              <textarea id="service-description" name="service_description" rows="5">{{ service_description|default:"" }}</textarea>
              <div class="character-count"><span id="description-chars">0</span>/500</div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Save Description</button>
              <button type="button" class="btn btn-secondary" id="cancel-description-edit">Cancel</button>
              <div class="description-status-message"></div>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Service List Section -->
    <div class="service-section">
      <h3>Your Services</h3>
      <div class="services-list" id="services-list">
        {% if handyman_services %}
          <div class="services-table">
            <div class="services-table-header">
              <div class="service-name-header">Service</div>
              <div class="service-rate-header">Hourly Rate</div>
              <div class="service-rate-header">Flat Rate</div>
              <div class="service-actions-header">Actions</div>
            </div>
            <div class="services-table-body">
              {% for service in handyman_services %}
              <div class="service-row" data-service-id="{{ service.id }}">
                <div class="service-name">{{ service.service.name }}</div>
                <div class="service-rate">{% if service.hourly_rate %}${{ service.hourly_rate }}{% else %}N/A{% endif %}</div>
                <div class="service-rate">{% if service.flat_rate %}${{ service.flat_rate }}{% else %}N/A{% endif %}</div>
                <div class="service-actions">
                  <button class="action-button edit-service" data-id="{{ service.id }}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="action-button delete delete-service" data-id="{{ service.id }}">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-tools"></i></div>
            <p>You haven't added any services yet.</p>
          </div>
        {% endif %}
        
        <button class="add-button" id="add-service-button">
          <i class="fas fa-plus"></i> Add Service
        </button>
      </div>
    </div>
    
    <!-- Add Service Form -->
    <div class="add-service-form-container" style="display: none;" id="add-service-form-container">
      <div class="service-section">
        <h3>Add a Service</h3>
        <form id="add-service-form" class="dashboard-form">
          {% csrf_token %}
          <div class="form-group">
            <label for="service-select">Service Type</label>
            <select id="service-select" name="service_id" required>
              <option value="">Select a service</option>
              {% for service in all_services %}
                <option value="{{ service.id }}">{{ service.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="hourly-rate">Hourly Rate (Optional)</label>
              <div class="input-with-symbol">
                <span class="input-symbol">$</span>
                <input type="number" id="hourly-rate" name="hourly_rate" step="0.01" min="0" placeholder="0.00">
              </div>
            </div>
            <div class="form-group">
              <label for="flat-rate">Flat Rate (Optional)</label>
              <div class="input-with-symbol">
                <span class="input-symbol">$</span>
                <input type="number" id="flat-rate" name="flat_rate" step="0.01" min="0" placeholder="0.00">
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Add Service</button>
            <button type="button" class="btn btn-secondary" id="cancel-service-add">Cancel</button>
            <div class="service-status-message"></div>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Mobile sidebar toggle
    const hamburgerBtn = document.querySelector('.dashboard-hamburger');
    const closeSidebarBtn = document.querySelector('.close-sidebar');
    const sidebar = document.querySelector('.dashboard-sidebar');
    const overlay = document.querySelector('.dashboard-overlay');
    
    if (hamburgerBtn) {
      hamburgerBtn.addEventListener('click', function() {
        sidebar.classList.add('open');
        overlay.classList.add('active');
      });
    }
    
    if (closeSidebarBtn) {
      closeSidebarBtn.addEventListener('click', function() {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
      });
    }
    
    if (overlay) {
      overlay.addEventListener('click', function() {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
      });
    }
    
    // Calculate profile completion
    const calculateProfileCompletion = () => {
      const progressBar = document.getElementById('profile-progress');
      const percentageDisplay = document.querySelector('.completion-percentage');
      
      if (progressBar && percentageDisplay) {
        const percent = {{ profile_completion|default:75 }};
        progressBar.style.width = percent + '%';
        percentageDisplay.textContent = percent + '%';
      }
    };
    
    calculateProfileCompletion();
    
    // Service Description Functionality
    const editDescriptionBtn = document.getElementById('edit-description-button');
    const descriptionDisplay = document.querySelector('.service-description-display');
    const descriptionForm = document.querySelector('.service-description-form');
    const cancelDescriptionBtn = document.getElementById('cancel-description-edit');
    const descriptionTextarea = document.getElementById('service-description');
    const charCount = document.getElementById('description-chars');
    const serviceDescriptionForm = document.getElementById('service-description-form');
    const descriptionStatusMessage = document.querySelector('.description-status-message');
    
    if (editDescriptionBtn) {
      editDescriptionBtn.addEventListener('click', function() {
        descriptionDisplay.style.display = 'none';
        descriptionForm.style.display = 'block';
        
        if (charCount && descriptionTextarea) {
          charCount.textContent = descriptionTextarea.value.length;
        }
      });
    }
    
    if (cancelDescriptionBtn) {
      cancelDescriptionBtn.addEventListener('click', function() {
        descriptionForm.style.display = 'none';
        descriptionDisplay.style.display = 'block';
      });
    }
    
    if (descriptionTextarea && charCount) {
      descriptionTextarea.addEventListener('input', function() {
        charCount.textContent = this.value.length;
      });
    }
    
    if (serviceDescriptionForm) {
      serviceDescriptionForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Clear any previous messages
        descriptionStatusMessage.textContent = '';
        descriptionStatusMessage.className = 'description-status-message';
        
        const formData = new FormData(serviceDescriptionForm);
        
        fetch('{% url "handyman_update_service_description" %}', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            descriptionStatusMessage.textContent = data.message;
            descriptionStatusMessage.classList.add('success');
            
            // Update the displayed description
            const currentDescription = document.getElementById('current-service-description');
            if (currentDescription) {
              currentDescription.textContent = formData.get('service_description');
            }
            
            // Hide form, show display
            setTimeout(function() {
              descriptionForm.style.display = 'none';
              descriptionDisplay.style.display = 'block';
            }, 1500);
          } else {
            descriptionStatusMessage.textContent = data.message;
            descriptionStatusMessage.classList.add('error');
          }
        })
        .catch(error => {
          console.error('Error updating service description:', error);
          descriptionStatusMessage.textContent = 'An error occurred while updating your service description.';
          descriptionStatusMessage.classList.add('error');
        });
      });
    }
    
    // Service Management Functionality
    const addServiceBtn = document.getElementById('add-service-button');
    const addServiceForm = document.getElementById('add-service-form-container');
    const cancelServiceAddBtn = document.getElementById('cancel-service-add');
    const serviceStatusMessage = document.querySelector('.service-status-message');
    const addServiceFormElement = document.getElementById('add-service-form');
    
    if (addServiceBtn) {
      addServiceBtn.addEventListener('click', function() {
        addServiceForm.style.display = 'block';
      });
    }
    
    if (cancelServiceAddBtn) {
      cancelServiceAddBtn.addEventListener('click', function() {
        addServiceForm.style.display = 'none';
      });
    }
    
    if (addServiceFormElement) {
      addServiceFormElement.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Clear any previous messages
        serviceStatusMessage.textContent = '';
        serviceStatusMessage.className = 'service-status-message';
        
        const formData = new FormData(addServiceFormElement);
        
        fetch('{% url "handyman_add_service" %}', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            serviceStatusMessage.textContent = data.message;
            serviceStatusMessage.classList.add('success');
            
            // Reload page to show updated services list
            setTimeout(function() {
              window.location.reload();
            }, 1500);
          } else {
            serviceStatusMessage.textContent = data.message;
            serviceStatusMessage.classList.add('error');
          }
        })
        .catch(error => {
          console.error('Error adding service:', error);
          serviceStatusMessage.textContent = 'An error occurred while adding the service.';
          serviceStatusMessage.classList.add('error');
        });
      });
    }
  });
</script>
{% endblock %} 