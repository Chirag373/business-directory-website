{% extends "handyman/handyman_dashboard.html" %}
{% load static %}

{% block dashboard_content %}
<section class="dashboard-content active" id="jobs-section">
  <h2>Job Management</h2>
  
  <!-- Jobs Summary Stats -->
  <div class="jobs-stats">
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-clock"></i></div>
      <div class="stat-number">{{ pending_jobs.count }}</div>
      <div class="stat-label">Pending Jobs</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-hammer"></i></div>
      <div class="stat-number">{{ active_jobs.count }}</div>
      <div class="stat-label">Active Jobs</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
      <div class="stat-number">{{ completed_jobs.count }}</div>
      <div class="stat-label">Completed Jobs</div>
    </div>
  </div>
  
  <!-- Jobs Tabs -->
  <div class="jobs-tab-container">
    <div class="jobs-tabs">
      <button class="jobs-tab-button active" data-tab="pending">Pending <span class="badge">{{ pending_jobs.count }}</span></button>
      <button class="jobs-tab-button" data-tab="active">In Progress <span class="badge">{{ active_jobs.count }}</span></button>
      <button class="jobs-tab-button" data-tab="completed">Completed <span class="badge">{{ completed_jobs.count }}</span></button>
      <button class="jobs-tab-button" data-tab="all">All Jobs <span class="badge">{{ all_jobs.count }}</span></button>
    </div>
    
    <!-- Pending Jobs Tab -->
    <div class="jobs-tab-content active" id="pending-jobs">
      {% if pending_jobs %}
        <div class="jobs-table">
          <div class="jobs-table-header">
            <div class="job-id">ID</div>
            <div class="job-client">Client</div>
            <div class="job-service">Service</div>
            <div class="job-date">Date</div>
            <div class="job-actions">Actions</div>
          </div>
          <div class="jobs-table-body">
            {% for job in pending_jobs %}
              <div class="job-row pending" data-job-id="{{ job.id }}">
                <div class="job-id">#{{ job.id }}</div>
                <div class="job-client">{{ job.client.get_full_name|default:job.client.email }}</div>
                <div class="job-service">{{ job.service.name }}</div>
                <div class="job-date">{{ job.scheduled_date|date:"M d, Y" }} at {{ job.scheduled_time }}</div>
                <div class="job-actions">
                  <button class="job-action-btn accept" data-job-id="{{ job.id }}" data-action="accepted">
                    <i class="fas fa-check"></i> Accept
                  </button>
                  <button class="job-action-btn reject" data-job-id="{{ job.id }}" data-action="cancelled">
                    <i class="fas fa-times"></i> Reject
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="empty-state">
          <i class="fas fa-clock empty-icon"></i>
          <p>No pending jobs</p>
        </div>
      {% endif %}
    </div>
    
    <!-- Active Jobs Tab -->
    <div class="jobs-tab-content" id="active-jobs">
      {% if active_jobs %}
        <div class="jobs-table">
          <div class="jobs-table-header">
            <div class="job-id">ID</div>
            <div class="job-client">Client</div>
            <div class="job-service">Service</div>
            <div class="job-date">Date</div>
            <div class="job-actions">Actions</div>
          </div>
          <div class="jobs-table-body">
            {% for job in active_jobs %}
              <div class="job-row active" data-job-id="{{ job.id }}">
                <div class="job-id">#{{ job.id }}</div>
                <div class="job-client">{{ job.client.get_full_name|default:job.client.email }}</div>
                <div class="job-service">{{ job.service.name }}</div>
                <div class="job-date">{{ job.scheduled_date|date:"M d, Y" }} at {{ job.scheduled_time }}</div>
                <div class="job-actions">
                  <button class="job-action-btn complete" data-job-id="{{ job.id }}" data-action="completed">
                    <i class="fas fa-check-double"></i> Complete
                  </button>
                  <button class="job-details-btn" data-job-id="{{ job.id }}">
                    <i class="fas fa-info-circle"></i> Details
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="empty-state">
          <i class="fas fa-hammer empty-icon"></i>
          <p>No active jobs</p>
        </div>
      {% endif %}
    </div>
    
    <!-- Completed Jobs Tab -->
    <div class="jobs-tab-content" id="completed-jobs">
      {% if completed_jobs %}
        <div class="jobs-table">
          <div class="jobs-table-header">
            <div class="job-id">ID</div>
            <div class="job-client">Client</div>
            <div class="job-service">Service</div>
            <div class="job-date">Completed</div>
            <div class="job-actions">Actions</div>
          </div>
          <div class="jobs-table-body">
            {% for job in completed_jobs %}
              <div class="job-row completed" data-job-id="{{ job.id }}">
                <div class="job-id">#{{ job.id }}</div>
                <div class="job-client">{{ job.client.get_full_name|default:job.client.email }}</div>
                <div class="job-service">{{ job.service.name }}</div>
                <div class="job-date">{{ job.completed_at|date:"M d, Y" }}</div>
                <div class="job-actions">
                  <button class="job-details-btn" data-job-id="{{ job.id }}">
                    <i class="fas fa-info-circle"></i> Details
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="empty-state">
          <i class="fas fa-check-circle empty-icon"></i>
          <p>No completed jobs</p>
        </div>
      {% endif %}
    </div>
    
    <!-- All Jobs Tab -->
    <div class="jobs-tab-content" id="all-jobs">
      {% if all_jobs %}
        <div class="jobs-table">
          <div class="jobs-table-header">
            <div class="job-id">ID</div>
            <div class="job-client">Client</div>
            <div class="job-service">Service</div>
            <div class="job-date">Date</div>
            <div class="job-status">Status</div>
            <div class="job-actions">Actions</div>
          </div>
          <div class="jobs-table-body">
            {% for job in all_jobs %}
              <div class="job-row {{ job.status }}" data-job-id="{{ job.id }}">
                <div class="job-id">#{{ job.id }}</div>
                <div class="job-client">{{ job.client.get_full_name|default:job.client.email }}</div>
                <div class="job-service">{{ job.service.name }}</div>
                <div class="job-date">{{ job.scheduled_date|date:"M d, Y" }}</div>
                <div class="job-status">
                  <span class="status-badge {{ job.status }}">
                    {{ job.get_status_display }}
                  </span>
                </div>
                <div class="job-actions">
                  <button class="job-details-btn" data-job-id="{{ job.id }}">
                    <i class="fas fa-info-circle"></i> Details
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="empty-state">
          <i class="fas fa-clipboard-list empty-icon"></i>
          <p>No jobs available</p>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Job Details Modal -->
  <div class="modal" id="job-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Job Details</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="job-details-content">
          <!-- Content will be loaded dynamically -->
          <div class="job-detail-row">
            <div class="detail-label">Job ID:</div>
            <div class="detail-value" id="modal-job-id"></div>
          </div>
          <div class="job-detail-row">
            <div class="detail-label">Client:</div>
            <div class="detail-value" id="modal-client"></div>
          </div>
          <div class="job-detail-row">
            <div class="detail-label">Service:</div>
            <div class="detail-value" id="modal-service"></div>
          </div>
          <div class="job-detail-row">
            <div class="detail-label">Status:</div>
            <div class="detail-value" id="modal-status"></div>
          </div>
          <div class="job-detail-row">
            <div class="detail-label">Scheduled Date:</div>
            <div class="detail-value" id="modal-date"></div>
          </div>
          <div class="job-detail-row">
            <div class="detail-label">Scheduled Time:</div>
            <div class="detail-value" id="modal-time"></div>
          </div>
          <div class="job-detail-row">
            <div class="detail-label">Address:</div>
            <div class="detail-value" id="modal-address"></div>
          </div>
          <div class="job-detail-row">
            <div class="detail-label">Description:</div>
            <div class="detail-value" id="modal-description"></div>
          </div>
          <div class="job-detail-row" id="modal-promotion-row">
            <div class="detail-label">Promotion Applied:</div>
            <div class="detail-value" id="modal-promotion"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="close-details-button">Close</button>
        <button class="btn btn-primary hidden" id="modal-action-button">Update Status</button>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Jobs tab functionality
    const tabButtons = document.querySelectorAll('.jobs-tab-button');
    const tabContents = document.querySelectorAll('.jobs-tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabId = this.dataset.tab;
        
        // Hide all tab contents
        tabContents.forEach(content => {
          content.classList.remove('active');
        });
        
        // Deactivate all tab buttons
        tabButtons.forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Activate clicked tab
        this.classList.add('active');
        document.getElementById(tabId + '-jobs').classList.add('active');
      });
    });
    
    // Job action button functionality
    const actionButtons = document.querySelectorAll('.job-action-btn');
    
    function handleJobAction(event) {
      const jobId = this.dataset.jobId;
      const action = this.dataset.action;
      const jobRow = document.querySelector(`.job-row[data-job-id="${jobId}"]`);
      
      if (confirm(`Are you sure you want to ${action === 'accepted' ? 'accept' : action === 'completed' ? 'mark as complete' : 'reject'} this job?`)) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('status', action);
        
        fetch(`{% url "handyman_update_job_status" job_id=0 %}`.replace('0', jobId), {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Remove job from current list
            jobRow.remove();
            
            // Check if there are no more jobs in this tab
            const tabContent = jobRow.closest('.jobs-tab-content');
            const jobRows = tabContent.querySelectorAll('.job-row');
            
            if (jobRows.length === 0) {
              // Show empty state
              const emptyIcon = action === 'accepted' ? 'clock' : action === 'completed' ? 'hammer' : 'check-circle';
              const emptyMessage = action === 'accepted' ? 'No pending jobs' : action === 'completed' ? 'No active jobs' : 'No completed jobs';
              
              tabContent.innerHTML = `
                <div class="empty-state">
                  <i class="fas fa-${emptyIcon} empty-icon"></i>
                  <p>${emptyMessage}</p>
                </div>
              `;
            }
            
            // Update the job counts
            updateJobCounts();
            
            // Show success message
            alert(data.message);
          } else {
            alert(data.message);
          }
        })
        .catch(error => {
          console.error('Error updating job status:', error);
          alert('An error occurred while updating the job status.');
        });
      }
    }
    
    actionButtons.forEach(button => {
      button.addEventListener('click', handleJobAction);
    });
    
    // Job details modal functionality
    const modal = document.getElementById('job-details-modal');
    const detailsButtons = document.querySelectorAll('.job-details-btn');
    const closeModalBtn = document.querySelector('.close-modal');
    const closeDetailsBtn = document.getElementById('close-details-button');
    
    function openJobDetailsModal(jobId) {
      // Here you would normally fetch job details from the server
      // For now, we'll just use dummy data from the DOM
      const jobRow = document.querySelector(`.job-row[data-job-id="${jobId}"]`);
      
      if (jobRow) {
        const jobIdValue = jobRow.querySelector('.job-id').textContent;
        const client = jobRow.querySelector('.job-client').textContent;
        const service = jobRow.querySelector('.job-service').textContent;
        const date = jobRow.querySelector('.job-date').textContent;
        const status = jobRow.classList.contains('pending') ? 'Pending' :
                      jobRow.classList.contains('active') ? 'In Progress' :
                      jobRow.classList.contains('completed') ? 'Completed' : 
                      'Unknown';
        
        // Set modal values
        document.getElementById('modal-job-id').textContent = jobIdValue;
        document.getElementById('modal-client').textContent = client;
        document.getElementById('modal-service').textContent = service;
        document.getElementById('modal-status').textContent = status;
        document.getElementById('modal-date').textContent = date.split(' at ')[0] || date;
        document.getElementById('modal-time').textContent = date.split(' at ')[1] || 'N/A';
        document.getElementById('modal-address').textContent = 'Client address'; // This would come from server
        document.getElementById('modal-description').textContent = 'Job description would be loaded from server.';
        
        // Hide promotion if not applicable
        const promotionRow = document.getElementById('modal-promotion-row');
        promotionRow.style.display = 'none';
        
        // Show modal
        modal.style.display = 'flex';
      }
    }
    
    detailsButtons.forEach(button => {
      button.addEventListener('click', function() {
        const jobId = this.dataset.jobId;
        openJobDetailsModal(jobId);
      });
    });
    
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });
    }
    
    if (closeDetailsBtn) {
      closeDetailsBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
    
    // Function to update job counts (this would normally fetch from server)
    function updateJobCounts() {
      const pendingCount = document.querySelectorAll('#pending-jobs .job-row').length;
      const activeCount = document.querySelectorAll('#active-jobs .job-row').length;
      const completedCount = document.querySelectorAll('#completed-jobs .job-row').length;
      const allCount = pendingCount + activeCount + completedCount;
      
      // Update badges
      document.querySelector('[data-tab="pending"] .badge').textContent = pendingCount;
      document.querySelector('[data-tab="active"] .badge').textContent = activeCount;
      document.querySelector('[data-tab="completed"] .badge').textContent = completedCount;
      document.querySelector('[data-tab="all"] .badge').textContent = allCount;
      
      // Update stat cards
      const statCards = document.querySelectorAll('.stat-number');
      if (statCards.length >= 3) {
        statCards[0].textContent = pendingCount;
        statCards[1].textContent = activeCount;
        statCards[2].textContent = completedCount;
      }
    }
  });
</script>
{% endblock %} 