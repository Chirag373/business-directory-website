{% extends "base.html" %}
{% load static %}

{% block title %}Handyman Signup - Business Directory 2.0{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/signup_shared.css' %}">
<link rel="stylesheet" href="{% static 'css/handyman_signup.css' %}">
{% endblock %}

{% block content %}
<section class="profile-section">
  <h2 class="profile-title">Handyman Registration</h2>
  <p class="profile-subtitle">Create your business account to offer your services</p>
  
  <!-- Progress Indicator -->
  <ul class="progress-indicator">
    <li class="progress-step completed">
      <div class="progress-number">1</div>
      <div class="progress-label">Account Type</div>
    </li>
    <li class="progress-step active">
      <div class="progress-number">2</div>
      <div class="progress-label">Business Details</div>
    </li>
    <li class="progress-step">
      <div class="progress-number">3</div>
      <div class="progress-label">Confirmation</div>
    </li>
  </ul>

  <div class="alert-box">
    <p><strong>Note:</strong> Please make sure your business card is clear and legible. This helps us verify your business information.</p>
  </div>

  <form class="profile-form" method="post" action="{% url 'signup_handyman' %}" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="form-section">
      <h3 class="section-title">Personal Information</h3>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="first-name" class="form-label">First Name</label>
            <input type="text" id="first-name" name="first_name" class="form-control" required>
          </div>
        </div>

        <div class="form-col">
          <div class="form-group">
            <label for="last-name" class="form-label">Last Name</label>
            <input type="text" id="last-name" name="last_name" class="form-control" required>
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">Business Information</h3>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="business-name" class="form-label">Business Name</label>
            <input type="text" id="business-name" name="business_name" class="form-control" required>
          </div>
        </div>

        <div class="form-col">
          <div class="form-group">
            <label for="website" class="form-label">Website URL</label>
            <input type="url" id="website" name="website" class="form-control" placeholder="https://example.com">
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">Contact Information</h3>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" id="email" name="email" class="form-control" required>
          </div>
        </div>

        <div class="form-col">
          <div class="form-group">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" id="phone" name="phone" class="form-control" required>
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">Business Address</h3>

      <div class="form-row">
        <div class="form-col" style="flex: 0.3;">
          <div class="form-group">
            <label for="address-number" class="form-label">Address Number</label>
            <input type="text" id="address-number" name="address_number" class="form-control" required>
          </div>
        </div>

        <div class="form-col" style="flex: 0.7;">
          <div class="form-group">
            <label for="address" class="form-label">Street Address</label>
            <input type="text" id="address" name="address" class="form-control" required>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="country" class="form-label">Country</label>
            <select id="country" name="country" class="form-control" required>
              <option value="">Select Country</option>
              <!-- Countries will be loaded via JavaScript -->
            </select>
          </div>
        </div>

        <div class="form-col">
          <div class="form-group">
            <label for="state" class="form-label">State/Province</label>
            <select id="state" name="state" class="form-control" disabled required>
              <option value="">Select State</option>
              <!-- States will be loaded via JavaScript -->
            </select>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="city" class="form-label">City</label>
            <select id="city" name="city" class="form-control" disabled required>
              <option value="">Select City</option>
              <!-- Cities will be loaded via JavaScript -->
            </select>
          </div>
        </div>

        <div class="form-col">
          <div class="form-group">
            <label for="zip" class="form-label">ZIP/Postal Code</label>
            <input type="text" id="zip" name="zip" class="form-control" required>
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">Service Information</h3>
      
      <div class="form-group">
        <label for="service-description" class="form-label">Service Description</label>
        <textarea id="service-description" name="service_description" class="form-control" rows="4" required placeholder="Describe the services you offer"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Service Categories</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="cat-plumbing" name="service_categories" value="Plumbing">
            <label for="cat-plumbing">Plumbing</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="cat-electrical" name="service_categories" value="Electrical">
            <label for="cat-electrical">Electrical</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="cat-carpentry" name="service_categories" value="Carpentry">
            <label for="cat-carpentry">Carpentry</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="cat-painting" name="service_categories" value="Painting">
            <label for="cat-painting">Painting</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="cat-landscaping" name="service_categories" value="Landscaping">
            <label for="cat-landscaping">Landscaping</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="cat-general" name="service_categories" value="General Repairs">
            <label for="cat-general">General Repairs</label>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <div class="checkbox-container">
          <input type="checkbox" id="run-promotion" name="run_promotion">
          <label for="run-promotion" class="checkbox-label">Create a promotional offer</label>
        </div>
      </div>
      
      <div id="promotion-options" style="display: none;">
        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label for="discount-percentage" class="form-label">Discount Percentage</label>
              <select id="discount-percentage" name="discount_percentage" class="form-control">
                <option value="">Select discount</option>
                <option value="5">5%</option>
                <option value="10">10%</option>
                <option value="15">15%</option>
                <option value="20">20%</option>
                <option value="25">25%</option>
                <option value="30">30%</option>
                <option value="50">50%</option>
              </select>
            </div>
          </div>
          
          <div class="form-col">
            <div class="form-group">
              <label for="discount-description" class="form-label">Promotion Description (Optional)</label>
              <input type="text" id="discount-description" name="discount_description" class="form-control" placeholder="E.g., First-time client discount">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">Business Card</h3>
      <p>Please upload images of your business card</p>

      <div class="file-upload-container">
        <div class="form-group">
          <label for="card-front" class="form-label">Front Side (Required)</label>
          <input type="file" id="card-front" name="card_front" accept="image/*" class="form-control" required>
        </div>
        <div class="card-preview" id="front-preview">
          <span class="card-preview-text">Preview will appear here</span>
        </div>
      </div>

      <div class="file-upload-container">
        <div class="form-group">
          <label for="card-back" class="form-label">Back Side (Optional)</label>
          <input type="file" id="card-back" name="card_back" accept="image/*" class="form-control">
        </div>
        <div class="card-preview" id="back-preview">
          <span class="card-preview-text">Preview will appear here</span>
        </div>
      </div>

      <div class="checkbox-container">
        <input type="checkbox" id="blank-back" name="blank_back">
        <label for="blank-back" class="checkbox-label">Please check this checkbox if your business card backside is blank</label>
      </div>
    </div>

    <div class="subscription-info">
      <h4>Standard Account - $19.99/month</h4>
      <p>Your handyman account gives you visibility to customers and the ability to offer your services with all basic features.</p>
    </div>

    <div class="navigation-controls">
      <a href="{% url 'register' %}" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
      <button type="submit" class="submit-btn">Submit <i class="fas fa-check"></i></button>
    </div>
  </form>
</section>

<!-- Script for image preview and validation -->
<script src="{% static 'js/address_dropdowns.js' %}"></script>
<script>
  // Load countries when the page loads
  document.addEventListener('DOMContentLoaded', async function() {
    const countryDropdown = document.getElementById('country');
    
    // Fetch countries from API
    try {
      const response = await fetch('/api/countries/');
      if (!response.ok) {
        throw new Error('Failed to fetch countries');
      }
      
      const countries = await response.json();
      
      // Add countries to dropdown
      countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country.iso2;
        option.textContent = country.name;
        countryDropdown.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading countries:', error);
    }
    
    // File preview functionality
    function setupFilePreview(fileInput, previewElement) {
      fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewElement.style.backgroundImage = `url(${e.target.result})`;
            previewElement.classList.add('has-image');
            previewElement.querySelector('.card-preview-text').style.display = 'none';
          }
          reader.readAsDataURL(file);
        } else {
          previewElement.style.backgroundImage = 'none';
          previewElement.classList.remove('has-image');
          previewElement.querySelector('.card-preview-text').style.display = 'block';
        }
      });
    }
    
    // Setup front and back previews
    setupFilePreview(document.getElementById('card-front'), document.getElementById('front-preview'));
    setupFilePreview(document.getElementById('card-back'), document.getElementById('back-preview'));
    
    // Promotion options toggle
    const runPromotionCheckbox = document.getElementById('run-promotion');
    const promotionOptions = document.getElementById('promotion-options');
    
    if (runPromotionCheckbox && promotionOptions) {
      runPromotionCheckbox.addEventListener('change', function() {
        promotionOptions.style.display = this.checked ? 'block' : 'none';
      });
    }
    
    // Form validation
    document.querySelector('.profile-form').addEventListener('submit', function(e) {
      let valid = true;
      const requiredInputs = this.querySelectorAll('[required]');
      
      requiredInputs.forEach(input => {
        if (!input.value && !input.disabled) {
          valid = false;
          input.classList.add('error');
        } else {
          input.classList.remove('error');
        }
      });
      
      const frontCard = document.getElementById('card-front');
      const blankBack = document.getElementById('blank-back');
      const backCard = document.getElementById('card-back');
      
      // Validate business card upload
      if (!frontCard.files.length) {
        valid = false;
        frontCard.classList.add('error');
      }
      
      if (!blankBack.checked && !backCard.files.length) {
        valid = false;
        backCard.classList.add('error');
      }
      
      // Validate that at least one service category is selected
      const serviceCategories = document.querySelectorAll('input[name="service_categories"]:checked');
      if (serviceCategories.length === 0) {
        valid = false;
        document.querySelector('.checkbox-group').classList.add('error');
        alert('Please select at least one service category.');
      } else {
        document.querySelector('.checkbox-group').classList.remove('error');
      }
      
      // Validate promotion details if promotion is enabled
      if (document.getElementById('run-promotion').checked) {
        const discountPercentage = document.getElementById('discount-percentage').value;
        if (!discountPercentage) {
          valid = false;
          document.getElementById('discount-percentage').classList.add('error');
        } else {
          document.getElementById('discount-percentage').classList.remove('error');
        }
      }
      
      if (!valid) {
        e.preventDefault();
        window.scrollTo(0, 0);
      }
    });
  });
</script>

<style>
  /* Checkbox group styles */
  .checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  
  .checkbox-item {
    display: flex;
    align-items: center;
  }
  
  .checkbox-item input[type="checkbox"] {
    margin-right: 8px;
  }
  
  .checkbox-group.error {
    border: 1px solid #e74c3c;
    padding: 10px;
    border-radius: var(--border-radius);
    background-color: rgba(231, 76, 60, 0.05);
  }
  
  /* Promotion options styling */
  #promotion-options {
    margin-top: 15px;
    padding: 15px;
    background-color: var(--light-bg-color);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
  }
</style>
{% endblock %} 